#!/usr/bin/env bash

set -euo pipefail

fail() {
  echo "ERROR: $*" >&2
  exit 1
}

log() {
  echo "INFO: $*" >&2
}

find_extracted_src_dir() {
  local download_path=$1
  local candidate

  # Prefer directories that contain bin/initdb
  for candidate in "$download_path"/*; do
    if [[ -d "$candidate" && -x "$candidate/bin/initdb" ]]; then
      echo "$candidate"
      return 0
    fi
  done

  # Fallback: first directory
  candidate=$(find "$download_path" -mindepth 1 -maxdepth 1 -type d | head -n1 || true)
  if [[ -n "${candidate}" ]]; then
    echo "$candidate"
    return 0
  fi

  return 1
}

copy_tree() {
  local src=$1
  local dst=$2

  mkdir -p "$dst"
  # Prefer rsync if available for robustness; otherwise cp -a
  if command -v rsync >/dev/null 2>&1; then
    rsync -a "$src/" "$dst/"
  else
    # shellcheck disable=SC2174
    cp -a "$src/." "$dst/"
  fi
}

install_prebuilt() {
  local install_type=$1
  local version=$2
  local install_path=$3
  local download_path=${ASDF_DOWNLOAD_PATH:?ASDF_DOWNLOAD_PATH not set}

  log "Installing PostgreSQL ${version} from prebuilt binaries"
  log "Download path: ${download_path}"
  log "Install path: ${install_path}"

  # Find extracted source directory (created by bin/download)
  local src_dir
  src_dir=$(find_extracted_src_dir "$download_path") || fail "Could not locate extracted PostgreSQL directory in ${download_path}"

  log "Using extracted directory: ${src_dir}"

  # Copy files into install path
  copy_tree "$src_dir" "$install_path"

  # Ensure data directory exists
  mkdir -p "$install_path/data"

  # Initialize database unless skipped
  if [[ -z "${POSTGRES_SKIP_INITDB:-}" ]]; then
    if [[ -x "$install_path/bin/initdb" ]]; then
      "$install_path/bin/initdb" -D "$install_path/data" -U postgres || fail "initdb failed"
    else
      fail "initdb not found at $install_path/bin/initdb"
    fi
  else
    log "POSTGRES_SKIP_INITDB set; skipping initdb"
  fi
}

install_prebuilt "${ASDF_INSTALL_TYPE:-version}" "${ASDF_INSTALL_VERSION:-}" "${ASDF_INSTALL_PATH:?ASDF_INSTALL_PATH not set}"
